FROM python:3.11-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∞—è SSL
RUN apt-get update && apt-get install -y \
    gcc \
    sqlite3 \
    openssl \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# –ö–æ–ø–∏—Ä—É–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
#COPY ssl_certs/server.crt /app/ssl/server.crt
#COPY ssl_certs/server.key /app/ssl/server.key
#RUN mkdir -p /app/ssl

# –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Django
RUN echo "ALLOWED_HOSTS = ['*']" >> /app/afk_back/settings.py
RUN echo "CORS_ALLOW_ALL_ORIGINS = True" >> /app/afk_back/settings.py

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏ –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
RUN mkdir -p /app/media/gallery
RUN touch /app/media/gallery/.gitkeep

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
RUN chmod -R 755 /app/media

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–ø–æ–∫
RUN echo '#!/bin/bash' > /app/fix_media_folders.sh && \
    echo 'mkdir -p /app/media/gallery' >> /app/fix_media_folders.sh && \
    echo 'chmod -R 755 /app/media' >> /app/fix_media_folders.sh && \
    echo 'touch /app/media/gallery/.gitkeep' >> /app/fix_media_folders.sh && \
    echo 'echo "–ü–∞–ø–∫–∏ —Å–æ–∑–¥–∞–Ω—ã: $(ls -la /app/media/)"' >> /app/fix_media_folders.sh && \
    chmod +x /app/fix_media_folders.sh

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤..."' >> /app/start.sh && \
    echo '/app/fix_media_folders.sh' >> /app/start.sh && \
    echo 'echo "üöÄ –ó–∞–ø—É—Å–∫ Django —Å–µ—Ä–≤–µ—Ä–∞..."' >> /app/start.sh && \
    echo 'python manage.py runserver 0.0.0.0:8000' >> /app/start.sh && \
    chmod +x /app/start.sh

# –ó–∞–ø—É—Å–∫–∞–µ–º Django —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–∞–ø–æ–∫
CMD ["/app/start.sh"]
